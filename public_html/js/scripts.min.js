$(document).ready(function(){var a={updateTask:function(h,g){if(g){g.addClass("saving")}$.ajax({type:"POST",url:"/tasks/update",data:h,success:function(j,k,i){if(i.status==302){window.location.reload()}if(g){$('<div class="saved">Saved</div>').appendTo(g).fadeIn("slow",function(){g.removeClass("saving");$(".saved").delay(500).fadeOut("slow",function(){$(".saved").remove()})})}}})},twoDigits:function(h){var g="0"+h;return g.substring(g.length-2)},toMysql:function(g){return g.getFullYear()+"-"+a.twoDigits(1+g.getMonth())+"-"+a.twoDigits(g.getDate())},updateOrder:function(g){$.ajax({type:"POST",url:"/tasks/sort_tasks",data:g.sortable("serialize")})},handleLink:function(l){var i=l.parent(".task-row"),k,j=$("#link-href"),g=(j.val()!==j.attr("title")&&j.val())||"",h=$("#link-text"),m=(h.val()!==h.attr("title")&&h.val())||g;$("#link-editor").remove();if(g){g=g.match(/^https?:\/\//)?g:"http://"+g;k={id:i.data("id"),link_text:m,link_href:g};a.updateTask(k,i);if(!i.hasClass("linked")){l.find(".linker").before('<a class="linker break-link" href="#">Remove Link</a>');i.addClass("linked")}else{l.find(".link").remove()}$('<a class="link" href="'+g+'" target="_blank">'+m+"</a>").appendTo(l)}else{i.removeClass("linked")}i.removeClass("editing-link").find(".task").focus()},dateInfo:function(){this.url=window.location.href;this.date_seg=this.url.match(/[0-9\-]+$/);this.date=this.date_seg?this.date_seg[0]:a.toMysql(new Date());this.date_arr=this.date.split("-");this.year=Number(this.date_arr[0]);this.month=Number(this.date_arr[1]);this.day=Number(this.date_arr[2])}},e=(function(){function h(){$(document.body).height($(window).height())}function g(){$(".date-changer").hide();$(".link:hidden").show();if($("#link-editor").length){var j=$("#link-editor").parent();a.handleLink(j)}$(".edit-bar:visible").siblings(".task").focus().blur();$(".task-row").removeClass("edit-bar-open")}function i(j){j.stopPropagation()}return{init:function(){h();$(window).resize(this.resizeBodyHeight);$(".category").each(function(){var j=$(this);if(j.children(".task-row").length<1){j.addClass("empty")}});$(document.body).click(g);$(".category").click(i)}}}()),d=(function(){var g={showOn:"button",buttonText:"Pick Date",buttonImageOnly:true,buttonImage:"/ui/date-picker.png",dateFormat:"yy-mm-dd",defaultDate:a.dateInfo.date,gotoCurrent:true,maxDate:0,nextText:"Next Month",prevText:"Previous Month",onSelect:function(i,h){window.location="/tasks/completed/"+i}};return{init:function(){$("#date-input").datepicker(g);$("#ui-datepicker-div").appendTo($("#date-pick"))}}}()),c=(function(){function k(o){var n=$(".create-task");o.preventDefault();if(n.hasClass("creating-task")){n.removeClass("creating-task");$("#task-creator").remove()}else{$.get("/tasks/task_creator",function(q,r,p){if(p.status==302){window.location.reload()}n.append(q).addClass("creating-task");$("#task").focus()})}}function h(o){var n=$(this),p=n.val();if(p===n.attr("title")){n.val("")}}function j(o){var n=$(this),p=n.val();if(p===""){n.val(n.attr("title"));n.removeClass("has-text")}else{n.addClass("has-text")}}function i(n){n.preventDefault();$(this).parent().parent().parent().toggleClass("important")}function m(n){n.preventDefault();$(".create-task").removeClass("creating-task");$("#task-creator").hide().remove()}function l(u){var t=$("#categories").val(),q=$("#cat-"+t),p=$("#create-link-text"),s=$("#create-link-href"),n=s.val(),n=n&&(n!==s.attr("title"))&&(n.match(/^https?:\/\//)?n:"http://"+n),o=($("#task-creator").hasClass("important")?1:0),r=function(){q.removeClass("empty");a.updateOrder(q);$(".category").sortable("refresh")};u.preventDefault();$.ajax({type:"POST",url:"/tasks/create",data:{task:$("#task").val()||"",category_id:t,link_text:((n===s.attr("title")||p.val()===p.attr("title"))?"":p.val()),link_href:(n?n:""),important:o},success:function(w,x,v){if(v.status==302){window.location.reload()}$(".create-task").removeClass("creating-task");$("#task-creator").hide().remove();if(o){$(w).insertAfter(q.find("h2")).hide().fadeIn("fast",r)}else{$(w).appendTo(q).hide().fadeIn("fast",r)}}})}function g(n){n.preventDefault();$("#save-task").trigger("click")}return{init:function(){$("#create-task").click(k);$(".create-task").delegate(".creator-edit-bar input","focus",h);$(".create-task").delegate(".creator-edit-bar input","blur",j);$(".create-task").delegate(".flagger","click",i);$(".create-task").delegate("#cancel-task","click",m);$(".create-task").delegate("#save-task","click",l);$(".create-task").delegate("#submit-task","click",g)}}}()),f=(function(){var j={placeholder:"ui-placeholder",handle:".handle",connectWith:".category",remove:function(w,x){var y=$(this);if(y.children(".task-row").length<1){y.addClass("empty")}},update:function(w,x){var y=$(this);if(this===x.item.parent()[0]){a.updateOrder(y);a.updateTask({id:x.item.data("id"),task:x.item.find(".task").val(),category_id:y.data("cat-id")},x.item);y.removeClass("empty")}},stop:function(w,x){x.item.find(".task").focus()}},m={dateFormat:"yy-mm-dd",defaultDate:a.dateInfo.date,gotoCurrent:true,maxDate:0,nextText:"Next Month",prevText:"Previous Month",onSelect:function(y,x){var w=$(this).parent().parent().parent();if(y!==a.dateInfo.date){a.updateTask({id:w.data("id"),date_completed:y});w.fadeOut("slow",function(){w.remove()})}}};function u(w){$(".edit-bar-open").removeClass("edit-bar-open editing-link");$("#link-editor").remove();$(this).parent().addClass("edit-bar-open")}function t(A){var z=$(this),x=z.parent(".completed").parent(".task-row"),w=z.hasClass("checked"),y={id:x.data("id"),completed:(w?0:1),date_completed:(w?"NULL":a.toMysql(new Date())),task:x.find(".task").val(),important:0};A.preventDefault();a.updateTask(y,x);x.fadeOut("slow",function(){x.remove()})}function s(x){var w=$(this);x.preventDefault();a.updateTask({id:w.parent(".task-row").data("id"),task:w.val()},w.parent())}function o(x){var w=$(this).parent();x.preventDefault();a.updateTask({id:w.data("id"),task:w.find(".task").val()},w)}function k(x){var w=$(this).parent().parent();x.preventDefault();w.toggleClass("important");a.updateTask({id:w.data("id"),important:w.hasClass("important")?1:0},w)}function h(w){w.preventDefault();$(".confirm-delete").hide();$(".delete").show();$(this).hide().siblings(".confirm-delete").show()}function v(z){var y=$(this),w=y.attr("href"),x=y.parent().parent(".task-row");z.preventDefault();if(x.siblings(".task-row").length===0){x.parent().addClass("empty")}$.ajax({url:w,success:function(B,C,A){if(A.status==302){window.location.reload()}x.fadeOut("slow",function(){x.remove()})}})}function r(){$(".confirm-delete").hide();$(".delete").show()}function q(D){var C=$(this).parent(),B=C.parent(".task-row"),y,x="Label",A="URL",w="",z;D.preventDefault();if(B.hasClass("editing-link")){a.handleLink(C)}else{$("#link-editor").remove();if(B.hasClass("linked")){y=C.find(".link").hide();x=y.text();A=y.attr("href");w="has-text"}z=['<form id="link-editor" accept-charset="utf-8" method="post" action="http://chrisbreiding.com/tasks/update">','<input type="text" id="link-text" class="'+w+'" value="'+x+'" title="Label" />','<input type="text" id="link-href" class="'+w+'" value="'+A+'" title="URL" />','<input type="submit" id="save-link" value="Save Link">',"</form>"];$(z.join("")).appendTo(C);B.addClass("editing-link")}}function g(){var w=$(this),x=w.val();if(x===w.attr("title")){w.val("")}}function n(){var w=$(this),x=w.val();if(x===""){w.val(w.attr("title"));w.removeClass("has-text")}else{w.addClass("has-text")}}function i(x){var w=$(this).parent().parent();x.preventDefault();a.handleLink(w)}function p(z){var y=$(this),x=y.parent(),w=x.parent(".task-row");z.preventDefault();a.updateTask({id:w.data("id"),link_text:"",link_href:""},w);$("#link-editor").remove();x.find(".link").remove();y.remove();w.removeClass("linked editing-link").find(".task").focus()}function l(y){var x=$(this),w=x.parent().parent().parent();y.preventDefault();y.stopPropagation();$(".task-row").css("z-index",10);w.css("z-index",50);x.siblings(".date-changer").fadeIn()}return{init:function(){$(".category").delegate(".task","focus",u);$(".category").delegate(".check","click",t);$(".category").delegate(".task","change",s);$(".category").delegate(".save-task","click",o);$(".category").delegate(".flagger","click",k);$(".category").delegate(".delete","click",h);$(".category").delegate(".confirm-delete","click",v);$(".category").delegate(".task","focus",r);$(".category").delegate(".add-link","click",q);$(".category").delegate("#link-editor input","focus",g);$(".category").delegate("#link-editor input","blur",n);$(".category").delegate("#save-link","click",i);$(".category").delegate(".break-link","click",p);$(".category").sortable(j);$(".date-changer").datepicker(m);$(".date-change > a").click(l)}}}()),b=function(){e.init();d.init();c.init();f.init()};b()});