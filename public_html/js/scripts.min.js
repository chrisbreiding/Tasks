$(document).ready(function(){var d={updateTask:function(a,d){d&&d.addClass("saving");$.ajax({type:"POST",url:"/tasks/update",data:a,success:function(a,c,g){302==g.status&&window.location.reload();d&&$('<div class="saved">Saved</div>').appendTo(d).fadeIn("slow",function(){d.removeClass("saving");$(".saved").delay(500).fadeOut("slow",function(){$(".saved").remove()})})}})},pad:function(a){a="0"+a;return a.substring(a.length-2)},toMysql:function(a){return a.getFullYear()+"-"+d.pad(1+a.getMonth())+"-"+
d.pad(a.getDate())},updateOrder:function(a){$.ajax({type:"POST",url:"/tasks/sort_tasks",data:a.sortable("serialize")})},handleLink:function(a){var e=a.parent(".task-row"),f,c=$("#link-href"),c=c.val()!==c.attr("title")&&c.val()||"";f=$("#link-text");var g=f.val()!==f.attr("title")&&f.val()||c;$("#link-editor").remove();c?(c=c.match(/^https?:\/\//)?c:"http://"+c,f={id:e.data("id"),link_text:g,link_href:c},d.updateTask(f,e),e.hasClass("linked")?a.find(".link").remove():(a.find(".linker").before('<a class="linker break-link" href="#">Remove Link</a>'),
e.addClass("linked")),$('<a class="link" href="'+c+'" target="_blank">'+g+"</a>").appendTo(a)):e.removeClass("linked");e.removeClass("editing-link").find(".task").focus()}};d.date=function(){var a=window.location.href.match(/[0-9\-]+$/);return a?a[0]:d.toMysql(new Date)}();var k=function(){function a(){$(document.body).height($(window).height())}function e(){$(".date-changer").hide();$(".link:hidden").show();if($("#link-editor").length){var a=$("#link-editor").parent();d.handleLink(a)}$(".task-row").removeClass("edit-bar-open")}
function f(a){a.stopPropagation()}return{init:function(){a();$(window).resize(a);$(".category").each(function(){var a=$(this);1>a.children(".task-row").length&&a.addClass("empty")});$(document.body).click(e);$(".category").click(f)}}}(),l=function(){var a=$("#date-pick"),e={showOn:"button",buttonText:"Pick Date",buttonImageOnly:!0,buttonImage:"/ui/date-picker.png",dateFormat:"yy-mm-dd",defaultDate:d.date,gotoCurrent:!0,maxDate:0,nextText:"Next Month",prevText:"Previous Month",beforeShow:function(){a.addClass("date-picker-open")},
onSelect:function(a){window.location="/tasks/completed/"+a},onClose:function(){a.removeClass("date-picker-open")}};return{init:function(){$("#date-input").datepicker(e);$("#ui-datepicker-div").appendTo(a)}}}(),p=function(){function a(a){var d=$(".create-task");a.preventDefault();d.hasClass("creating-task")?(d.removeClass("creating-task"),$("#task-creator").remove()):$.get("/tasks/task_creator",function(a){d.append(a).addClass("creating-task");$("#task").focus()})}function e(){var a=$(this);a.val()===
a.attr("title")&&a.val("")}function f(){var a=$(this);""===a.val()?(a.val(a.attr("title")),a.removeClass("has-text")):a.addClass("has-text")}function c(a){a.preventDefault();$(this).parent().parent().parent().toggleClass("important")}function g(a){a.preventDefault();$(".create-task").removeClass("creating-task");$("#task-creator").hide().remove()}function m(a){var c=$("#categories").val(),e=$("#cat-"+c),f=$("#create-link-text"),g=$("#create-link-href"),h=g.val(),i=h&&i!==g.attr("title")&&(h.match(/^https?:\/\//)?
h:"http://"+h),j=$("#task-creator").hasClass("important")?1:0,r=function(){e.removeClass("empty");d.updateOrder(e);$(".category").sortable("refresh")};a.preventDefault();$.ajax({type:"POST",url:"/tasks/create",data:{task:$("#task").val()||"",category_id:c,link_text:i===g.attr("title")||f.val()===f.attr("title")?"":f.val(),link_href:i?i:"",important:j},success:function(a,d,c){302==c.status&&window.location.reload();$(".create-task").removeClass("creating-task");$("#task-creator").hide().remove();j?
$(a).insertAfter(e.find("h2")).hide().fadeIn("fast",r):$(a).appendTo(e).hide().fadeIn("fast",r)}})}function n(a){a.preventDefault();$("#save-task").trigger("click")}var o={connectToSortable:".category",helper:function(){return $('<div class="task-row ui-dropper"><div class="completed"><span></span><input class="task" /></div></div>')[0]},revert:"invalid",distance:20,start:function(){$(".category .ui-draggable").remove()},stop:function(){$dropped=$(".category .ui-placeholder");$dropped.length&&$.ajax({type:"POST",
url:"/tasks/create",data:{task:"",category_id:$dropped.closest(".category").data("cat-id"),link_text:"",link_href:"",important:0},success:function(a){$dropped.after(a);$(".newly-created").removeClass("newly-created").find(".task").focus()}})}};return{init:function(){$("#create-task").click(a).draggable(o);$(".create-task").delegate(".creator-edit-bar input","focus",e).delegate(".creator-edit-bar input","blur",f).delegate(".flagger","click",c).delegate("#cancel-task","click",g).delegate("#save-task",
"click",m).delegate("#submit-task","click",n)}}}(),q=function(){function a(){$(".edit-bar-open").removeClass("edit-bar-open editing-link");$("#link-editor").remove();$(this).parent().addClass("edit-bar-open")}function e(a){var b=$(this),c=b.parent(".completed").parent(".task-row"),b=b.hasClass("checked"),b={id:c.data("id"),completed:b?0:1,date_completed:b?"NULL":d.toMysql(new Date),task:c.find(".task").val(),important:0};a.preventDefault();d.updateTask(b,c);c.fadeOut("slow",function(){c.remove()})}
function f(a){var b=$(this);a.preventDefault();d.updateTask({id:b.parent(".task-row").data("id"),task:b.val()},b.parent())}function c(a){var b=$(this).parent();a.preventDefault();d.updateTask({id:b.data("id"),task:b.find(".task").val()},b)}function g(a){var b=$(this).parent().parent();a.preventDefault();b.toggleClass("important");d.updateTask({id:b.data("id"),important:b.hasClass("important")?1:0},b)}function m(a){a.preventDefault();$(".confirm-delete").hide();$(".delete").show();$(this).hide().siblings(".confirm-delete").show()}
function n(a){var b=$(this),d=b.attr("href"),c=b.parent().parent(".task-row");a.preventDefault();0===c.siblings(".task-row").length&&c.parent().addClass("empty");$.ajax({url:d,success:function(a,b,d){302==d.status&&window.location.reload();c.fadeOut("slow",function(){c.remove()})}})}function o(){$(".confirm-delete").hide();$(".delete").show()}function k(a){var b=$(this).parent(),c=b.parent(".task-row"),e="Label",f="URL",g="";a.preventDefault();c.hasClass("editing-link")?d.handleLink(b):($("#link-editor").remove(),
c.hasClass("linked")&&(a=b.find(".link").hide(),e=a.text(),f=a.attr("href"),g="has-text"),e=['<form id="link-editor" accept-charset="utf-8" method="post" action="http://chrisbreiding.com/tasks/update">','<input type="text" id="link-text" class="'+g+'" value="'+e+'" title="Label" />','<input type="text" id="link-href" class="'+g+'" value="'+f+'" title="URL" />','<input type="submit" id="save-link" value="Save Link">',"</form>"],$(e.join("")).appendTo(b),c.addClass("editing-link"))}function l(){var a=
$(this);a.val()===a.attr("title")&&a.val("")}function p(){var a=$(this);""===a.val()?(a.val(a.attr("title")),a.removeClass("has-text")):a.addClass("has-text")}function q(a){var b=$(this).parent().parent();a.preventDefault();d.handleLink(b)}function s(a){var b=$(this),c=b.parent(),e=c.parent(".task-row");a.preventDefault();d.updateTask({id:e.data("id"),link_text:"",link_href:""},e);$("#link-editor").remove();c.find(".link").remove();b.remove();e.removeClass("linked editing-link").find(".task").focus()}
function h(a){var b=$(this),c=b.parent().parent().parent();a.preventDefault();a.stopPropagation();$(".task-row").css("z-index",10);c.css("z-index",50);b.siblings(".date-changer").fadeIn()}var i={placeholder:"ui-placeholder",handle:".handle",connectWith:".category",revert:250,remove:function(){var a=$(this);1>a.children(".task-row").length&&a.addClass("empty")},update:function(a,b){var c=$(this);this===b.item.parent()[0]&&(d.updateOrder(c),d.updateTask({id:b.item.data("id"),task:b.item.find(".task").val(),
category_id:c.data("cat-id")},b.item),c.removeClass("empty"))},stop:function(a,b){b.item.find(".task").focus()}},j={dateFormat:"yy-mm-dd",defaultDate:d.date,gotoCurrent:!0,maxDate:0,nextText:"Next Month",prevText:"Previous Month",onSelect:function(a){var b=$(this).parent().parent().parent();a!==d.date&&(d.updateTask({id:b.data("id"),date_completed:a}),b.fadeOut("slow",function(){b.remove()}))}};return{init:function(){$(".category").delegate(".task","focus",a).delegate(".check","click",e).delegate(".task",
"change",f).delegate(".save-task","click",c).delegate(".flagger","click",g).delegate(".delete","click",m).delegate(".confirm-delete","click",n).delegate(".task","focus",o).delegate(".add-link","click",k).delegate("#link-editor input","focus",l).delegate("#link-editor input","blur",p).delegate("#save-link","click",q).delegate(".break-link","click",s).sortable(i);$(".date-changer").datepicker(j);$(".date-change > a").click(h)}}}();k.init();l.init();p.init();q.init()});