$(document).ready(function(){var c={updateTask:function(a,c){c&&c.addClass("saving");$.ajax({type:"POST",url:"/tasks/update",data:a,success:function(){c&&$('<div class="saved">Saved</div>').appendTo(c).fadeIn("slow",function(){c.removeClass("saving");$(".saved").delay(500).fadeOut("slow",function(){$(".saved").remove()})})}})},pad:function(a){a="0"+a;return a.substring(a.length-2)},toMysql:function(a){return a.getFullYear()+"-"+c.pad(1+a.getMonth())+"-"+c.pad(a.getDate())},updateOrder:function(a){$.ajax({type:"POST",
url:"/tasks/sort_tasks",data:a.sortable("serialize")})},handleLink:function(a){var d=a.closest(".task-row"),f,e=$("#link-href"),e=e.val()!==e.attr("title")?e.val():"";f=$("#link-text");var i=f.val()!==f.attr("title")?f.val():e;$("#link-editor").remove();e?(e=e.match(/^https?:\/\//)?e:"http://"+e,f={id:d.data("id"),link_text:i,link_href:e},c.updateTask(f,d),d.hasClass("linked")?a.find(".link").remove():(a.find(".linker").before('<a class="linker break-link" href="#">Remove Link</a>'),d.addClass("linked")),
$('<a class="link" href="'+e+'" target="_blank">'+i+"</a>").appendTo(a)):d.removeClass("linked");d.removeClass("editing-link").find(".task").focus()}};c.date=function(){var a=window.location.href.match(/[0-9\-]+$/);return a?a[0]:c.toMysql(new Date)}();var l=function(){function a(){$(document.body).height($(window).height())}function d(){$(".date-changer").hide();$(".link:hidden").show();if($("#link-editor").length){var a=$("#link-editor").closest(".edit-bar");c.handleLink(a)}$(".task-row").removeClass("edit-bar-open")}
function f(a){a.stopPropagation()}return{init:function(){a();$(window).resize(a);$(".category").each(function(){var a=$(this);1>a.find(".task-row").length&&a.addClass("empty")});$(document.body).click(d);$(".category").click(f)}}}(),m=function(){var a=$("#date-pick");return{init:function(){$("#date-input").datepicker({showOn:"button",buttonText:"Pick Date",buttonImageOnly:!0,buttonImage:"/ui/date-picker.png",dateFormat:"yy-mm-dd",defaultDate:c.date,gotoCurrent:!0,maxDate:0,nextText:"Next Month",prevText:"Previous Month",
beforeShow:function(){a.addClass("date-picker-open")},onSelect:function(a){window.location="/tasks/completed/"+a},onClose:function(){a.removeClass("date-picker-open")}});$("#ui-datepicker-div").appendTo(a)}}}(),q=function(){function a(a){var c=$(".create-task");a.preventDefault();c.hasClass("creating-task")?(c.removeClass("creating-task"),$("#task-creator").remove()):$.get("/tasks/task_creator",function(a){c.append(a).addClass("creating-task");$("#task").focus()})}function d(){var a=$(this);a.val()===
a.attr("title")&&a.val("")}function f(){var a=$(this);""===a.val()?(a.val(a.attr("title")),a.removeClass("has-text")):a.addClass("has-text")}function e(a){a.preventDefault();$("#task-creator").toggleClass("important")}function i(a){a.preventDefault();$(".create-task").removeClass("creating-task");$("#task-creator").hide().remove()}function n(a){a.preventDefault();var a=$("#categories").val(),e=$("#cat-"+a),d=e.find(".task-list"),f=$("#create-link-text"),i="",k=$("#create-link-href"),j=k.val(),b="",
g=$("#task-creator").hasClass("important")?1:0,h=function(){e.removeClass("empty");c.updateOrder(d);$(".task-list").sortable("refresh")};j&&j!==k.attr("title")&&(b=j.match(/^https?:\/\//)?j:"http://"+j);j&&(i=f.val()!==f.attr("title")?f.val():j);$.ajax({type:"POST",url:"/tasks/create",data:{task:$("#task").val()||"",category_id:a,link_text:i,link_href:b,important:g},success:function(a){$(".create-task").removeClass("creating-task");$("#task-creator").hide().remove();g?$(a).prependTo(d).hide().fadeIn("fast",
h):$(a).appendTo(d).hide().fadeIn("fast",h)}})}function o(a){a.preventDefault();$("#save-task").trigger("click")}var p={connectToSortable:".task-list",helper:function(){return $('<div class="task-row ui-dropper"><div class="completed"><span></span><input class="task" /></div></div>')[0]},revert:"invalid",distance:20,cursorAt:{top:25,left:15},start:function(){$(".task-list .ui-draggable").remove()},stop:function(){$dropped=$(".task-list .ui-placeholder");$dropped.length&&$.ajax({type:"POST",url:"/tasks/create",
data:{task:"",category_id:$dropped.closest(".category").data("cat-id"),link_text:"",link_href:"",important:0},success:function(a){$dropped.after(a);$(".newly-created").removeClass("newly-created").find(".task").focus()}})}};return{init:function(){$("#create-task").click(a).draggable(p);$(".create-task").delegate(".creator-edit-bar input","focus",d).delegate(".creator-edit-bar input","blur",f).delegate(".flagger","click",e).delegate("#cancel-task","click",i).delegate("#save-task","click",n).delegate("#submit-task",
"click",o)}}}(),r=function(){function a(){$(".edit-bar-open").removeClass("edit-bar-open editing-link");$("#link-editor").remove();$(this).closest(".task-row").addClass("edit-bar-open")}function d(a){var b=$(this),g=b.closest(".task-row"),b=b.hasClass("checked"),b={id:g.data("id"),completed:b?0:1,date_completed:b?"NULL":c.toMysql(new Date),task:g.find(".task").val(),important:0};a.preventDefault();c.updateTask(b,g);g.fadeOut("slow",function(){g.remove()})}function f(a){var b=$(this);a.preventDefault();
c.updateTask({id:b.closest(".task-row").data("id"),task:b.val()},b.closest(".task-row"))}function e(a){var b=$(this).closest(".task-row");a.preventDefault();c.updateTask({id:b.data("id"),task:b.find(".task").val()},b)}function i(a){var b=$(this).closest(".task-row");a.preventDefault();b.toggleClass("important");c.updateTask({id:b.data("id"),important:b.hasClass("important")?1:0},b)}function n(a){a.preventDefault();$(".confirm-delete").hide();$(".delete").show();$(this).hide().siblings(".confirm-delete").show()}
function o(a){var b=$(this),c=b.attr("href"),h=b.closest(".task-row");a.preventDefault();0===h.siblings(".task-row").length&&h.closest(".category").addClass("empty");$.ajax({url:c,success:function(a,b,j){302==j.status&&window.location.reload();h.fadeOut("slow",function(){h.remove()})}})}function p(){$(".confirm-delete").hide();$(".delete").show()}function l(a){var b=$(this).closest(".edit-bar"),g=b.closest(".task-row"),h="Label",e="URL",d="";a.preventDefault();g.hasClass("editing-link")?c.handleLink(b):
($("#link-editor").remove(),g.hasClass("linked")&&(a=b.find(".link").hide(),h=a.text(),e=a.attr("href"),d="has-text"),h=['<form id="link-editor" accept-charset="utf-8" method="post" action="http://chrisbreiding.com/tasks/update">','<input type="text" id="link-text" class="'+d+'" value="'+h+'" title="Label" />','<input type="text" id="link-href" class="'+d+'" value="'+e+'" title="URL" />','<input type="submit" id="save-link" value="Save Link">',"</form>"],$(h.join("")).appendTo(b),g.addClass("editing-link"))}
function m(){var a=$(this);a.val()===a.attr("title")&&a.val("")}function q(){var a=$(this);""===a.val()?(a.val(a.attr("title")),a.removeClass("has-text")):a.addClass("has-text")}function r(a){var b=$(this).closest(".edit-bar");a.preventDefault();c.handleLink(b)}function s(a){var b=$(this),e=b.closest(".edit-bar"),d=e.closest(".task-row");a.preventDefault();c.updateTask({id:d.data("id"),link_text:"",link_href:""},d);$("#link-editor").remove();e.find(".link").remove();b.remove();d.removeClass("linked editing-link").find(".task").focus()}
function k(a){var b=$(this),c=b.closest(".task-row");a.preventDefault();a.stopPropagation();$(".task-row").css("z-index",10);c.css("z-index",50);b.siblings(".date-changer").fadeIn()}return{init:function(){$(".task-list").delegate(".task","focus",a).delegate(".check","click",d).delegate(".task","change",f).delegate(".save-task","click",e).delegate(".flagger","click",i).delegate(".delete","click",n).delegate(".confirm-delete","click",o).delegate(".task","focus",p).delegate(".add-link","click",l).delegate("#link-editor input",
"focus",m).delegate("#link-editor input","blur",q).delegate("#save-link","click",r).delegate(".break-link","click",s).sortable({placeholder:"ui-placeholder",handle:".handle",connectWith:".task-list",revert:250,remove:function(){var a=$(this);a.find(".task-row").length||a.closest(".category").addClass("empty")},update:function(a,b){var e=$(this),d=e.closest(".category");d[0]===b.item.closest(".category")[0]&&(c.updateOrder(e),c.updateTask({id:b.item.data("id"),task:b.item.find(".task").val(),category_id:d.data("cat-id")},
b.item),d.removeClass("empty"))},stop:function(a,b){b.item.find(".task").focus()}});$(".date-changer").datepicker({dateFormat:"yy-mm-dd",defaultDate:c.date,gotoCurrent:!0,maxDate:0,nextText:"Next Month",prevText:"Previous Month",onSelect:function(a){var b=$(this).closest(".task-row");a!==c.date&&(c.updateTask({id:b.data("id"),date_completed:a}),b.fadeOut("slow",function(){b.remove()}))}});$(".date-change > a").click(k)}}}();l.init();m.init();q.init();r.init()});